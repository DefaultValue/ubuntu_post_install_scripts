# Docker-based PHP development infrastructure. From clean Ubuntu to deployed Magento 2 in 5 commands. #

This is a part of the local infrastructure project which aims to create easy to install and use environment for PHP
development based on Ubuntu LTS.

[Full YouTube presentation](https://www.youtube.com/watch?v=88fCLnOnLvA)

1. `Ubuntu post-installation scripts` (this repository) - install software,
clone repositories with `Docker infrastructure` and `Dockerizer for PHP` tool. Infrastructure is launched automatically
during setup and you do not need start it manually. Read below information to get more info about what software is installed,
where the files are located and why we think this software is needed.

2. Deprecated: [Docker infrastructure](https://github.com/DefaultValue/docker_infrastructure) - run [Traefik](https://traefik.io/)
reverse-proxy container with linked MySQL 5.6, 5.7, MariaDB 10.1, 10.3, phpMyAdmin and Mailhog containers.
Infrastructure is cloned and run automatically by the `Ubuntu post-installation scripts`.
Check this repository for more information on how the infrastructure works, how to use xDebug, etc.

3. [Dockerizer for PHP](https://github.com/DefaultValue/dockerizer_for_php) - install any Magento 2 version in 1
command. Add Docker files to your existing PHP projects in one command. This repository is cloned automatically
by the [Ubuntu post-installation scripts](https://github.com/DefaultValue/ubuntu_post_install_scripts). Please, check
[Dockerizer for PHP](https://github.com/DefaultValue/dockerizer_for_php) repository to get more information on available
commands and what the tool does.


## Running the script ##

Automated environment installation script for Ubuntu 20.04-21.10 x64 (22.04 is not yet supported - not all PPA
are ready). Download it and run:

```bash
sh ubuntu_20.04.sh
```

**Important!**

1. Do not run it with `sudo` or when you switch to the root user. Never. Otherwise, a lot of things may have
insufficient permissions.
2. If pulling Docker images fail - just run the script again.

**Ubuntu Upgrade**

Scripts can be re-run after upgrading your Ubuntu installation to the newer version (for example, from 21.10 to 22.04).


## Web-server application stack ##

See [Dockerizer for PHP](https://github.com/DefaultValue/dockerizer_for_php) and [Full YouTube presentation](https://www.youtube.com/watch?v=88fCLnOnLvA)


## Bash aliases ##

There are several useful aliases added to the `~/.bash_aliases` file:
- `UP` - start compositions generated by Dockerizer in the development mode;
- `DOWN` - stop compositions generated by Dockerizer without removing volumes;
- `PHP` - enter the PHP container from the `.dockerizer/<env>/` directory containing the `docker-compose.yaml` file (here and below);
- `PHPROOT` - enter the PHP container as root;
- `MY` - enter the Magento MySQL container using host OS client. Magento DB password is automatically copied from `app/etc/env.php` to the clipboard;
- `MYROOT` - enter the Magento MySQL container as `root` using container's MySQL client;

Docker composition aliases for working with Magento 2 without knowing the container name. Commands are executed in the
Docker container for `php` service. Run them in the directory containing the `docker-compose.yaml` file:
- `CC` - run `php bin/magento cache:clean`;
- `CF` - run `php bin/magento cache:flush`;
- `IR` - run `php bin/magento indexer:reindex`;
- `SDC` - run `php bin/magento setup:di:compile`;
- `SU` - run `php bin/magento setup:upgrade`;
- `URN` - run `php bin/magento dev:urn-catalog:generate` and replace `/var/www/html` with `$PROJECT_DIR$` (internal PHPStorm variable).

Misc (see [Dockerizer for PHP](https://github.com/DefaultValue/dockerizer_for_php) for more details);:
- `BUILD` - run Dockerizer command `composition:build-from-template`;
- `SETUP` - run Dockerizer command `magento:setup`;
- `REINSTALL` - run Dockerizer command `magento:reinstall`;
- `CR` - remove all Magento 2 generated files in `pub/static/`, `var/` and other folders;
- `MCS` - run [Magento 2 coding standard](https://github.com/magento/magento-coding-standard) checks with `--severity=1` (strict check). Usage - `MSC <path to the code to check>` (see [Magento Coding Standard](https://github.com/magento/magento-coding-standard))
- `MND` - run [PHP Magic Number detector](https://github.com/povils/phpmnd)


## Installed software list ##

- `curl` - ool to transfer data to or from a server;
- `Diodon` (20.04) - clipboard manager;
- `Docker + docker-compose` - spin up development environments;
- `Dropbox` - file sharing tool;
- `htop` - process manager;
- `git & git-gui` - version control system;
- `Google Chrome` - browser;
- `guake` - pulldown terminal;
- `KeePassXC (to be deprecated soon)` - password storage;
- `mc` (Midnight Commander) - console file manager;
- `mkcert` - generating trusted SSL certificates for local development;
- `mysql-client` - MySQL client;
- `nodejs, php` - needs no introduction;
- `PHPStorm` - IDE;
- `Shutter` - making and editing screenshots;
- `Sublime Text` - text editor;
- `Slack` - messenger;
- `Tweaks` - Ubuntu fine-tuning;
- `vim` - console text editor that you can't exit;
- `VirtualBox` - virtualization tool for setting up Windows and other OS.

**PHP modules that are installed:**
- bz2
- cli
- common
- curl
- intl
- mbstring
- mysql
- opcache
- readline
- ssh2
- xml
- xdebug
- zip

`xDebug` is configured automatically and does not require additional adjustments if you use PHPStorm. `php.ini` settings are updated for development environment.
You may also want to download the [free Microsoft IE/Edge virtual machines for VirtualBox](https://developer.microsoft.com/ru-ru/windows/downloads/virtual-machines/)


## In case HTTPS is still insecure ##

If the certificates generated by `mkcert` are insecure then run the following and restart the browser:

```bash
mkcert -install
```

This may happen because browsers are not started during the software installation and local CA is not trusted yet.


## Tips for developers ##

1) Create bookmark for at least `~/misc` folder in Nautilus (file manager) - just move the folder to the left sidebar of Nautilus to add it to bookmarks.

2) Use Ubuntu `Startup Applications` to automate launching apps on system startup.

3) Use `Guake` dropdown terminal as an alternative to Terminal application. Set it to, for example, F1 key. Set switching tabs to ALT+1, ALT+2 and so on because this is a default shortkut for many other apps.

4) Enable workspaces in Ubuntu and learn how to use them (if not yet) and how to move windows between workspaces. You may like using static number of workspaces instead of dynamically adding/removing them. 

If you prefer to loop through the current workspace apps only rather than all apps on all workspaces:

```bash
gsettings set org.gnome.shell.app-switcher current-workspace-only true
```

5) Use `Tweaks` to fine-tune your system.

6) It is possible to customize terminal output to show current time and Git branch when you-re inside the repository. Use `$PS1` like this in your `~/.bashr_aliases`:

```bash
PS1='\[\033[01;35m\][\d \t] \[\033[01;33m\]\w\[\033[01;31m\]\[\033[01;34m\]$(__git_ps1)\[\033[01;31m\] > \[\033[01;32m\]'

# If this is an xterm set the title to user@host:dir
case "$TERM" in
xterm*|rxvt*)
    # PS1="\[\e]0;${debian_chroot:+($debian_chroot)}\u@\h: \w\a\]$PS1"
    PS1="\[\e]0;${debian_chroot:+($debian_chroot)}\w\a\]$PS1"
    ;;
*)
    ;;
esac
```

Or take this one as an example and modify it for your needs. Be sure to backup the file before that.


## Author and maintainer ##

[Maksym Zaporozhets](mailto:maksimz@default-value.com)
